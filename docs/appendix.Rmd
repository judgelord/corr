---
title: "Appendix"
subtitle: "Unequal Representation: Evidence from a Census of Legislator Contacts with US Federal Agencies"
output:
    html_document:
      highlight: zenburn
      toc: true
      toc_float: true
      code_folding: hide
    #   toc: true
    #   keep_tex: true
    # pdf_document:
editor_options: 
  chunk_output_type: console
---


```{r global.options, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      cache = TRUE, 
                      fig.width=8.5, 
                      split = T,
                      fig.align = 'center', 
                      fig.path='figs/',
                      fig.retina = 10,
                      warning=FALSE, 
                      message=FALSE)



library(modelsummary)
library(marginaleffects)
library(fixest)
library(tidyverse)
library(magrittr)
library(tidytext)
library(xml2)
library(knitr)
library(kableExtra)
library(here)
library(ggrepel)

# library(lfe)

library(ggplot2); theme_set(theme_bw())
  options(
    ggplot2.continuous.color = "cividis",
    ggplot2.continuous.fill = "cividis"
  )
  scale_color_discrete <- function(...)
    scale_color_viridis_d(..., direction = -1)
  scale_fill_discrete <- function(...)
    scale_fill_viridis_d(..., direction = -1)
  
  
kablebox <- . %>%  
  head(100) %>%
  knitr::kable() %>% 
  kable_styling() %>% 
  scroll_box(height = "200px")

kablebox_long <- . %>% 
  head(100) %>% 
  knitr::kable() %>% 
  kable_styling() %>% 
  scroll_box(height = "500px")
```

# Theory

Synthetic figures, ignoring baseline levels of each type.

## 2x2
```{r 2x2, fig.cap="Divergent Predictions for the Change in Levels of Constituency Service and Policy Work as Legislators Gain Experience and Power", fig.width=7, fig.height=5.5}
library(tidyverse)
x2 <- read_csv(here::here("data", "2x2.csv"))
# 
# x2 %>% 
#   ggplot() +
#   aes(x = x, y = new, label = lab) +
#   geom_line(aes(y = baseline), linetype = 2, alpha = .5) + 
#   geom_line() +
#   geom_ribbon(aes(ymax = new, ymin = baseline), alpha = .2) + 
#   facet_wrap("outcome", nrow = 2) + 
#   geom_label() +  
#   geom_text(aes(label = lab2, y = baseline), check_overlap = T, hjust = 0, vjust = -.2) +
#   labs(y = "Change in Level Provided\n(e.g., the number of requests to agencies)",
#        title = "") + 
#   theme_void() + 
#   xlim(-.2,1.2) + 
#   ylim(-1.1,3.1) + 
#   theme(panel.border = element_rect(fill=NA),
#         axis.title.y = element_text(angle = 90))



x2 %>% 
  ggplot() +
  aes(x = x, y = new, label = lab) +
  geom_line(aes(y = baseline), linetype = 2, alpha = .5) + 
  geom_line() +
  geom_ribbon(aes(ymax = new, ymin = baseline), alpha = .2) + 
  facet_grid(priority ~ capacity) +
  geom_label() +  
  geom_text(y = 0, 
            label = "Baseline levels for new legislator\n(may differ between service and policy work)",
            aes(x = ifelse(capacity == "Capacity DOES affect behavior" & priority == "Shifting priorities DO affect behavior", 0.5, NA))) +
  labs(y = "Change in Level Provided\n(e.g., the number of requests to agencies)",
       title = "",
       x = "") + 
  #theme_minimal() + 
  xlim(-.2,1.2) + 
  ylim(-1.1,3.1) + 
  theme(panel.grid = element_blank(),
        panel.border = element_rect(fill=NA),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.background = element_blank())


# x2 %>% 
#   ggplot() +
#   aes(x = x, y = new, label = lab) +
#   #geom_point(aes(y = baseline), alpha = .5) + 
#   #geom_line() +
#   geom_segment(aes(yend = baseline, xend = x), alpha = .2, size = 20) + 
#   facet_wrap("outcome", nrow = 2) + 
#   geom_label() +  
#   geom_text(aes(label = lab2, y = baseline), check_overlap = T, hjust = 0, vjust = 1.5) +
#   labs(y = "Change in Level Provided\n(e.g., the number of requests to agencies)",
#        title = "") + 
#   theme_void() + 
#   xlim(-.1,1.1) + 
#   ylim(-1.1,3.1) + 
#   theme(panel.border = element_rect(fill=NA),
#         axis.title.y = element_text(angle = 90))
```

## 1x2
```{r 1x2, fig.cap="Divergent Predictions for the Change in Levels of Constituency Service and Policy Work as Legislators Gain Experience and Power", fig.width=6.5, fig.height=2.5}
# just 
x2 %>% 
  filter(outcome %in% c("3. Only Increased Capacity Affects Behavior", "2. Only Shifting Priorities Affect Behavior")) %>% 
  mutate(outcome = str_remove(outcome, "[1-9].*Only ")) %>%
  ggplot() +
  aes(x = x, y = new, label = lab) +
  geom_line(aes(y = baseline), linetype = 2, alpha = .5) + 
  geom_line() +
  geom_ribbon(aes(ymax = new, ymin = baseline), alpha = .2) + 
  facet_wrap("outcome", nrow = 1) + 
  geom_label() +  
  geom_text(y = 0, 
            vjust = 1.1,
            label = "Baseline levels for a new legislator\n(may differ between service & policy work)",
            aes(x = ifelse(outcome == "Increased Capacity Affects Behavior", 0.5, NA))) +
  labs(y = "Change in Level Provided\n(e.g., the number of\nrequests to agencies)",
       title = "") + 
  theme_void() + 
  xlim(-.3,1.3) + 
  ylim(-1.1,1.1) + 
  theme(panel.border = element_rect(fill=NA),
        axis.title.y = element_text(angle = 90))
```


# Data  
```{r, eval=TRUE}
FOIA <- read_csv(here("data/_FOIA_response_table.csv")) %>% select(-ends_with("1")) %>% 
  mutate(Department = Department %>% str_remove("Department of ")) 

FOIA %>% 
  kablebox_long()

FOIA %>% select(-Coded) %>%
  rename(N = Observations) %>% 
  kable(format = "latex", booktabs = T) %>%
  row_spec(row = 16, hline_after = TRUE) %>%
  row_spec(row = 17, bold = T) %>% 
  #kable_styling(font_size = 9, full_width = TRUE) %>% 
       write_file(here::here("tables", "FOIA.tex")) 
```

```{r data, cache=FALSE}
# can't cache data

# new raw data 
load(
  here::here("data", "all_contacts.Rdata") %>% 
       str_replace("Correspondence","correspondence_data")
     ) 

all_contacts %>% count(TYPE != "NA") %>% pull(n) %>% .[[2]] %>% write(file = here::here("docs/tables/n_coded"))
# 
# # old raw data 
# load(
#   here::here("data", "all_contacts2.Rdata") 
#      ) 


all_contacts2 <- all_contacts #FIXME 

#load(here::here("data", "all_contacts_paper.Rdata"))

all_contacts2 %<>% mutate(type = ifelse(TYPE %in% c(1,2,3), "Constituency\nService", NA) ) %>%
  mutate(type = ifelse(TYPE %in% c(4,5), "Policy\nWork", type) )

all_contacts2$Type %<>% str_replace("Indiv. Constituent" , "Constituent (Individual)") %>% 
  str_replace("Corp. Constituent" , "Constituent (Corporate)")%>% 
  str_replace("501c3 or Local Gov." , "Constituent (501c3 or Local Gov.)")%>% 
  str_replace("Corp. Policy" , "Policy (Corporate)")%>% 
  str_replace("^Policy$" , "Policy (General)")


load(here::here("data", "dcounts_min.Rdata"))
load(here::here("data", "dcounts_tenure.Rdata"))
load(here::here("data", "dcounts_ratio.Rdata"))
load(here::here("data", "dcounts_per_district.Rdata"))


load(here::here("data", "members.Rdata"))

members %<>% mutate(member_state = member_state %>%
                     str_replace("\\) ", "-") %>%
                     str_c(")")) 


congress_years2<- function(congress){
		years<- c(congress*2 + 1787, congress*2 + 1788 ) %>% str_c(collapse = ";", sep = ";")
		return(years)
}

# FIXME members data should have years so we don't merge in observations for members in the january (final days of their last term)
# members2 <- members %>%
# mutate(year = congress %>%  congress_years2() %>% str_c(collapse = ";"))

# CAUTION THIS IS WRONG AND WILL PRINT OUT ALL YEARS IN DATA ^2
# members2$year[1]

load(here::here('data', 'agency_vars.Rdata'))

congress_years<- function(congress){
		years<- c(congress*2 + 1787, congress*2 + 1788 )
		return(years)
}

year_congress<- function(year){
	return(floor((year - 1787)/2))
}



d <- dcounts_min %>% 
  ungroup() %>% 
  mutate(type = ifelse(TYPE %in% c(1,2,3), "Constituency\nService", NA) ) %>%
  mutate(type = ifelse(TYPE %in% c(4,5), "Policy\nWork", type) )

type <- d %>% 
  group_by(type) %>% 
  summarise(n = sum(per_icpsr_chamber_year_agency_type)) %>% 
  ungroup()


type %>% 
  rename(type2 = type) %>%
  mutate(percent = n/sum(type$n[1:2])*100) %>% kablebox()



type5 <- d %>% 
  group_by(TYPE) %>% 
  summarise(n = sum(per_icpsr_chamber_year_agency_type)) %>% 
  ungroup() 

type5 %<>% 
  mutate(percent = n/sum(type5$n[2:6])*100)

type5 %>% kablebox()


type2017 <- d %>% 
  filter(year> 2006, year < 2018) %>%
  group_by(type) %>% 
  summarise(n = sum(per_icpsr_chamber_year_agency_type)) %>%
  ungroup()

coded <- d %>% 
  mutate(coded = !is.na(type)) %>% 
  group_by(coded) %>% 
  summarise(n = sum(per_icpsr_chamber_year_agency_type)) 

coded_ratio = coded$n[2]/(sum(coded$n))

multiplier = sum(coded$n)/coded$n[2]

percent <- function(x){
  y <- x*100 
  y %<>% round() 
  return(y)}
# percent(.434534523453)

d %<>% filter(chamber != "President")

d %<>% mutate(congress = year_congress(year))




dcounts <- d %>% left_join(members)


type2xchair <- dcounts %>% 
  group_by(type, chair) %>% 
  summarise(n = sum(per_icpsr_chamber_year_agency_type)) %>% 
  ungroup() %>% 
  drop_na(type, chair) %>% 
  group_by(chair) %>% 
  mutate(percent = n / sum(n) *100) 

type2xchair%>% 
  kablebox()

type2xprestigechair <- dcounts %>% 
  group_by(type, prestige_chair) %>% 
  summarise(n = sum(per_icpsr_chamber_year_agency_type)) %>% 
  ungroup() %>% 
  drop_na() %>% 
  group_by(prestige_chair) %>% 
  mutate(percent = n / sum(n) *100) 

type2xprestigechair%>% 
  kablebox()


# prestige committee
type2xprestige <- dcounts %>% 
  group_by(type, prestige) %>% 
  summarise(n = sum(per_icpsr_chamber_year_agency_type)) %>% 
  ungroup() %>% 
  drop_na() %>% 
  group_by(prestige) %>% 
  mutate(percent = n / sum(n) *100) 


type2xprestigechair%>% 
  kablebox()


type2xchamber <- dcounts %>%
  group_by(type, chamber) %>% 
  summarise(n = sum(per_icpsr_chamber_year_agency_type)) %>% 
  ungroup() %>% 
  drop_na() %>% 
  group_by(chamber) %>% 
  mutate(percent = n / sum(n) *100) 


# year
type2xyear <- dcounts %>% mutate(years = year  - yearelected) %>% 
  group_by(type, years) %>% 
  summarise(n = sum(per_icpsr_chamber_year_agency_type)) %>% 
  ungroup() %>% 
  drop_na() %>% 
  group_by(years) %>% 
  mutate(percent = n / sum(n) *100) 

type2xyear %>% 
  kablebox()


#  averages 
dcounts %>%
  group_by(year, bioname) %>% 
  summarise(n = sum(per_icpsr_chamber_year_agency_type)) %>% 
  ungroup() %>% 
  arrange(-n) %>%
  summarise(mean_per_year = mean(n) %>% round(0)) %>% 
  kablebox()


# chamber averages 
dcounts %>%
  group_by(chamber, year, bioname) %>% 
  summarise(n = sum(per_icpsr_chamber_year_agency_type)) %>% 
  ungroup() %>% 
  arrange(-n) %>%
  group_by(chamber) %>% 
  summarise(mean_per_year = mean(n) %>% round(0)) %>% 
  kablebox()


# per member 
dcounts %>% 
  group_by(bioname, year) %>% summarise(n = sum(per_icpsr_chamber_year_agency_type)) %>% 
  ungroup() %>% 
  arrange(-n) %>%
  group_by(bioname) %>% 
  mutate(mean_per_year = mean(n) %>% round(0)) %>% 
  kablebox_long()

# per member HOUSE
dcounts %>% 
  filter(chamber == "House") %>% 
  group_by(bioname, year) %>% summarise(n = sum(per_icpsr_chamber_year_agency_type)) %>% 
  ungroup() %>% 
  arrange(-n) %>%
  group_by(bioname) %>% 
  mutate(mean_per_year = mean(n) %>% round(0)) %>% 
  kablebox_long()

# per member VA-10
dcounts %>% 
  filter(cqlabel == "(VA-10)") %>% 
  group_by(bioname, year) %>% summarise(n = sum(per_icpsr_chamber_year_agency_type)) %>% 
  ungroup() %>% 
  arrange(year) %>%
  group_by(bioname) %>% 
  mutate(mean_per_year = mean(n) %>% round(0)) %>% 
  kablebox_long()

dcounts %>% 
  group_by(bioname, year) %>% summarise(n = sum(per_icpsr_chamber_year_agency_type)) %>% 
  ungroup() %>% 
  arrange(n) %>%
  group_by(bioname) %>% 
  mutate(mean_per_year = mean(n) %>% round(0)) %>% 
  #FIXME 
  filter(n > 4) %>% 
  kablebox_long()


```


##  Example

Rep. Barbara Comstock worked in Rep. Frank Wolf's congressional office for five years, described him as a "longtime mentor," and claimed that Wolf first urged her to run for office. He endorsed and campaigned with her. 

Notice several patterns
- dip in constituency service when Wolf is no longer running for re-election
- further dip with transition
- quick rebound as Comstock gets her office in order
- inheriting a highly-effective office, Comstock is far above average house member

```{r va-10, fig.width=5.3, fig.height=2.5}
cq <- "(VA-10)"

dcounts %>% 
  group_by(member_state, year, chamber, cqlabel) %>% summarise(n = sum(per_icpsr_chamber_year_agency_type)) %>% 
  ungroup() %>% 
  group_by(chamber) %>% 
  mutate(mean_per_chamber = mean(n) %>% round(0)) %>% 
  filter(cqlabel == cq, year > 2007, year <2017) %>% 
  ggplot() +
  aes(x = year, y = n, fill = member_state) + 
  geom_col(alpha = .5, position = "dodge") +
  geom_hline(aes(yintercept = mean_per_chamber), linetype = 2) + 
  geom_text(aes(y = mean_per_chamber), x = 2007.5, label = "House mean", min.segment.length = 0, size = 3, fill = NA, vjust = -.3, hjust = 0) + 
  scale_x_continuous(breaks = seq(2008, 2016, 1)) +
  labs(x = "",
       y = "Number of Requests", 
       fill = cq %>% str_remove_all("\\(|\\)")) + 
  theme_minimal() + 
  theme(panel.grid.major.x =  element_blank(),
        panel.grid.minor.x =  element_blank(),
        axis.text.x = element_text(angle = 45))+ 
    scale_fill_viridis_d(begin = 0, end = .6, option = "cividis", direction = -1) 

```


```{r ny-14}
cq <- "(NY-07)"
CHAMBER <- "House"
dcounts %>% 
  group_by(member_state, year, chamber, cqlabel) %>% summarise(n = sum(per_icpsr_chamber_year_agency_type)) %>% 
  ungroup() %>% 
  group_by(chamber) %>% 
  mutate(mean_per_chamber = mean(n) %>% round(0)) %>% 
  ggplot() +
  aes(x = year, y = n, 
      fill = member_state %>% str_replace("-.*", "\\)")) + 
  geom_col(alpha = .5, position = "dodge") +
  geom_hline(aes(yintercept = mean_per_chamber), linetype = 2) + 
  geom_text(aes(y = mean_per_chamber), x = 2007.5, label = "Chamber average", min.segment.length = 0, size = 3, fill = NA, vjust = 1.3, hjust = 0) + 
  scale_x_continuous(breaks = seq(2007, 2017, 1)) +
  labs(x = "",
       y = "Number of Requests", 
       fill = str_c(CHAMBER, "-", cq) %>% str_remove_all("\\(|\\)") ) + 
  theme_minimal() + 
  theme(panel.grid.major.x =  element_blank(),
        panel.grid.minor.x =  element_blank(),
        axis.text.x = element_text(angle = 45))+ 
    scale_fill_viridis_d(begin = 0, end = .6, option = "cividis", direction = -1) 


cq <- "(NY-14)"
CHAMBER <- "House"
dcounts %>% 
  group_by(member_state, year, chamber, cqlabel) %>% summarise(n = sum(per_icpsr_chamber_year_agency_type)) %>% 
  ungroup() %>% 
  group_by(chamber) %>% 
  mutate(mean_per_chamber = mean(n) %>% round(0)) %>% 
  filter(cqlabel == cq, year > 2007, year <2019) %>% 
  ggplot() +
  aes(x = year, y = n, 
      fill = member_state %>% str_replace("-.*", "\\)")) + 
  geom_col(alpha = .5, position = "dodge") +
  geom_hline(aes(yintercept = mean_per_chamber), linetype = 2) + 
  geom_text(aes(y = mean_per_chamber), x = 2007.5, label = "Chamber average", min.segment.length = 0, size = 3, fill = NA, vjust = 1.3, hjust = 0) + 
  scale_x_continuous(breaks = seq(2008, 2017, 1)) +
  labs(x = "",
       y = "Number of Requests", 
       fill = str_c(CHAMBER, "-", cq) %>% str_remove_all("\\(|\\)") ) + 
  theme_minimal() + 
  theme(panel.grid.major.x =  element_blank(),
        panel.grid.minor.x =  element_blank(),
        axis.text.x = element_text(angle = 45))+ 
    scale_fill_viridis_d(begin = 0, end = .6, option = "cividis", direction = -1) 
```


```{r cases, eval=FALSE}
case_study <- function(cq){

  CHAMBER <- filter(members, cqlabel == cq) %>% 
    .$chamber %>% .[1]

dcounts %>% 
  group_by(member_state, year, chamber, cqlabel) %>% summarise(n = sum(per_icpsr_chamber_year_agency_type)) %>% 
  ungroup() %>% 
  group_by(chamber) %>% 
  mutate(mean_per_chamber = mean(n) %>% round(0)) %>% 
  filter(cqlabel == cq, year > 2007, year <2017) %>% 
  ggplot() +
  aes(x = year, 
      y = n, 
      fill = member_state %>% str_replace("-.*", "\\)")) + 
  geom_col(alpha = .5, position = "dodge") +
  geom_hline(aes(yintercept = mean_per_chamber), linetype = 2) + 
  geom_text(aes(y = mean_per_chamber), x = 2007.5, label = "Chamber average",# min.segment.length = 0,
            size = 3, vjust = 1.3, hjust = 0) + 
  scale_x_continuous(breaks = seq(2008, 2016, 1)) +
  labs(x = "",
       y = "Number of Requests", 
       fill = str_c(CHAMBER, "-", cq) %>% str_remove_all("\\(|\\)") ) + 
  theme_minimal() + 
  theme(panel.grid.major.x =  element_blank(),
        panel.grid.minor.x =  element_blank(),
        axis.text.x = element_text(angle = 45))+ 
    scale_fill_viridis_d(begin = 0, end = .6, option = "cividis", direction = -1) 
  
ggsave(str_c("figs/districts/", cq, ".png"), 
       width = 5.3,
  height = 2.5,
  dpi = 1000)
} 

case_study("(WI)")

case_study("(WI-07)")

cases <- unique(members$cqlabel) #%>% head()

# map(cases, case_study )

```

---

Between February 2017 and February 2021, we received data on `r as.integer(sum(type$n))` instances of members of Congress contacting federal agencies. We focus on requests made from 2007-2017, resulting in a data set of `r as.integer(sum(type2017$n))` contacts from members of Congress with federal agencies.


## Requests by percentile


```{r percentiles, fig.height=3.4, fig.width=6, cache=TRUE}

dcounts %>% 
    group_by(member_state, chamber, year) %>% summarise(n = sum(per_icpsr_chamber_year_agency_type)) %>%
  group_by(member_state, chamber) %>% 
  summarise(mean = mean(n)) %>% 
  ungroup() %>% 
    group_by(chamber) %>% 
  mutate(Percentile = ntile(mean, 100),
         rank = dense_rank(-mean)) %>% 
  arrange(-Percentile) %>% 
  dplyr::select(member_state, Percentile, mean, chamber,rank) %>% distinct() %>% 
    ggplot() + 
    geom_col(aes(x = Percentile, y = mean), 
             color = "grey", 
             width = .000001,
             fill = "black",
             position = "dodge") + 
  geom_point(aes(x = Percentile, y = mean), color = "light blue") + 
  geom_text(aes(x = Percentile, y = mean, label = ifelse(rank <14 | Percentile < 30, member_state, "")), check_overlap = T, 
                  size = 2,
                  hjust = "inward") + 
  theme_minimal() + 
  labs(#title = "Average Legislator Requests per Year by Percentile",
       x = "Percentile Within Chamber",
       y = "Average Requests per Year") +     facet_grid(. ~ chamber , scales = "free_y") 

  
```


## Requests by year

```{r counts-per-year, fig.height=4, fig.width=6, cache=TRUE, eval=TRUE}
dcounts %<>% 
  group_by(bioname, year) %>% 
  mutate(per_bioname_year = sum(per_icpsr_chamber_year_agency_type)) %>%
  ungroup() %>% 
  group_by(year) %>%
  #mutate(per_bioname_year = per_bioname_year - mean(per_bioname_year)) %>% 
  ungroup() 

schumer2013 <- dcounts %>% filter(bioname == "SCHUMER, Charles Ellis (Chuck)",
                   year == 2013) %>% .$per_bioname_year %>% unique()

cruz2013 <- dcounts %>% filter(bioname == "CRUZ, Rafael Edward (Ted)",
                   year == 2013) %>% .$per_bioname_year %>% unique()

mcconnell2013 <- dcounts %>% filter(bioname == "McCONNELL, Addison Mitchell (Mitch)",
                   year == 2013) %>% .$per_bioname_year %>% unique()


p <- dcounts %>% 
  filter(year > 2006, year <2018) %>%
  distinct(bioname, per_bioname_year, year, chamber) %>% 
  filter(per_bioname_year > 0) %>% 
  ggplot() + 
  geom_line(aes(x = year, 
                y = per_bioname_year, 
                group = bioname, 
                color = chamber), 
            alpha = .1) +
  geom_line(aes(x = year, 
                group = bioname, 
                color = chamber,
                y = ifelse(bioname == "SCHUMER, Charles Ellis (Chuck)", per_bioname_year, NA))) + 
  geom_label(x = 2013, 
             y = schumer2013, 
             label = "Chuck Schumer") +
  geom_line(aes(x = year, group = bioname, color = chamber,
                y = ifelse(bioname == "CRUZ, Rafael Edward (Ted)", per_bioname_year, NA))) + 
  geom_label(x = 2013, 
             y = cruz2013, 
             label = "Ted Cruz") +
  geom_line(aes(x = year, group = bioname, color = chamber,
                y = ifelse(bioname == "McCONNELL, Addison Mitchell (Mitch)", per_bioname_year, NA))) + 
  geom_label(x = 2013, 
             y = mcconnell2013, 
             label = "Mitch McConnell") +
  labs(x = "",
       color = " ",
       y = paste("Requests per Legislator per Year"),
       title = "") +
  scale_x_continuous(breaks = unique(dcounts$year)) + 
  scale_color_viridis_d(begin = 0, end = .6, option = "cividis", direction = -1) +
  theme_minimal() + 
  theme(panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.text.x = element_text(angle = 30, vjust = 0)) 

# FIXME, this takes a long time 
p

ggsave(here::here("figs/counts-per-year.pdf"), p, height=3, width=6)
```   

## Requests by state population

```{r pop, fig.width=6, fig.height=4}
library(scales)


dcounts %>% 
  filter(chamber == "Senate") %>% 
    group_by(member_state, year, pop2010) %>% 
  summarise(n = sum(per_icpsr_chamber_year_agency_type)) %>% 
    group_by(member_state, pop2010) %>%
  summarise(mean = mean(n)) %>% ungroup() %>% 
    ggplot() + 
    geom_point(aes(x = pop2010, y = mean), color = "light blue") + 
    geom_smooth(aes(x = pop2010, y = mean)) + 
  geom_text_repel(aes(x = pop2010, 
                y = mean, 
                label = ifelse(mean > 260 |# & log(pop2010) < 17.4 | 
                                 mean < 80 & (log(pop2010) > 17 | log(pop2010) <14), 
                               member_state, 
                               "")), 
            seed = 44,
            check_overlap = T, 
            min.segment.length = 0,
            size = 2.5) + theme_bw() +
  labs(title = "",
       x = "State Population (log scale)",
       y = "Average Number of Requests per Year") +
  scale_x_log10(labels = comma)
```   

---

## Types of requests


`r percent(type$n[1]/(type$n[1]+type$n[2]) )`% of the average legislators' contacts with agencies are about constituency service.

`r percent(type$n[2]/(type$n[1]+type$n[2]))`% of the average legislators' contacts with agencies are about policy work.

`r type %>% kablebox()`

We classify legislator requests into five overall types:

All data:
```{r data_by_type-tall, fig.height=3.5, fig.width=5.5}
# paper figure 
type_totals <- all_contacts2 %>% 
  filter(Type != "To be coded") %>%  
  mutate(total = n()) %>% 
  group_by(Type, total, type) %>% 
  summarise(nT = n()) %>% 
  mutate(percent = paste0(nT, " = ", 100*round(nT/total, 2), "%"),
         Type = str_c(Type, "\n    ", percent)) %>% 
  ungroup() %>% 
  group_by(type) %>% 
  mutate(nt = sum(nT),
         percent_t = paste0(100*round(nt/total, 2), "%"))

type_totals %<>% mutate(Type = Type %>% 
                          str_replace_all("\\)", "") %>% 
                          str_replace_all(" \\(", ",\n") )

# horizontal
type_totals %>% 
  ggplot() + 
  geom_col(alpha = .7,aes(x = Type, fill = type, y = nT) ) + 
  scale_y_continuous(breaks = seq(0,500000, 50000), limits = c(0,500000)) + 
  labs(x = "",
       fill = "",
       y = paste("Number of Contacts"),
       title = "") +
  #geom_text(aes(label = Type, x = Type,y = nT) ) + 
  theme(panel.border = element_blank(),
        panel.grid.major.x = element_blank(),
        axis.ticks = element_blank(),
        #axis.text.x.top = element_text(),
        legend.position ="none") + 
  ggpubr::geom_bracket(
    xmin = type_totals$Type[1], xmax = type_totals$Type[3], 
    y.position = 380000,
    label = paste(type_totals$percent_t[1], "Constituency Service" ),
    #hjust = 1,
    vjust = -1
  ) + 
  ggpubr::geom_bracket(
    xmin = type_totals$Type[4], xmax = type_totals$Type[5], 
    y.position = 85000,
    label = paste(type_totals$percent_t[5], "Policy Work"),
    #hjust = 1,
    vjust = -1
  )+ 
  scale_fill_viridis_d(option = "cividis", end = .8, direction = -1)





all_contacts2 %>% 
  filter(Type != "To be coded") %>%  
  mutate(total = n()) %>% 
  group_by(Type, total, type) %>% 
  summarise(nT = n()) %>% 
  mutate(percent = paste0(nT, " = ", 100*round(nT/total, 2), "%"),
         Type = str_c(Type, "\n    ", percent)) %>% 
  ungroup() %>% 
  #distinct(type, Type, nT)
  ggplot() + 
  geom_col(alpha = .7,aes(x = type, fill = Type, y = nT), position ="stack") + 
  #coord_flip() + 
  scale_y_continuous(labels = scales::comma) + 
  labs(x = "",
       fill = "",
       y = paste("Number of Contacts\nN =", sum(nrow(all_contacts2))),
       title = "") +
  #theme_void() + 
  theme(panel.border = element_blank(),
        panel.grid.major.x = element_blank(),
        axis.ticks = element_blank(),
        axis.text.x = element_text())


```

Horizontal format:

```{r data_by_type, fig.height=2, fig.width=6, results='hide'}
type_totals %<>% 
  #distinct(type, Type, nT)
  mutate(Type = Type %>% str_replace(",\n", ", ")) 

type_totals %>% 
  ggplot() + 
  geom_col(alpha = .7,aes(x = Type, fill = type, y = nT/1000) ) + 
  coord_flip() + 
  scale_y_continuous(breaks = seq(0,500, 100), limits = c(0,700)) + 
  labs(x = "",
       fill = "",
       y = paste("Number of Contacts (Thousands)"),
       title = "") +
  #theme_void() + 
  theme(panel.border = element_blank(),
        panel.grid.major.y = element_blank(),
        axis.ticks = element_blank(),
        axis.text.x.top = element_text(),
        legend.position ="none") + 
  ggpubr::geom_bracket(
    xmin = type_totals$Type[1], xmax = type_totals$Type[3], y.position = 400,
    label = paste0(type_totals$percent_t[1], "\n", type_totals$type[1]),
    hjust = -.3,
    vjust = 1.5,
    label.size = 3.5
  ) + 
  ggpubr::geom_bracket(
    xmin = type_totals$Type[4], xmax = type_totals$Type[5], y.position = 100,
    label = paste0(type_totals$percent_t[5], "\n", type_totals$type[5]),
    hjust = -.3,
    vjust = 1,
    label.size = 3.5
  )


all_contacts2 %>% 
  filter(Type != "To be coded") %>%  
  mutate(total = n()) %>% 
  group_by(Type, total, type) %>% 
  summarise(nT = n()) %>% 
  mutate(percent = paste0(nT, " = ", 100*round(nT/total, 2), "%"),
         Type = str_c(Type, "\n    ", percent)) %>% 
  ungroup() %>% 
  #distinct(type, Type, nT)
  ggplot() + 
  geom_col(alpha = .7,aes(x = type, fill = Type, y = nT/1000), position ="stack") + 
  coord_flip() + 
  scale_y_continuous(breaks = seq(0,500, 50)) + 
  labs(x = "",
       fill = "",
       y = paste("Number of Contacts (Thousands)"),
       title = "") +
  #theme_void() + 
  theme(panel.border = element_blank(),
        panel.grid.major.y = element_blank(),
        axis.ticks = element_blank(),
        axis.text.x.top = element_text())
```

2007-2017 data:
```{r data_by_type-2001-2017, fig.height=2, fig.width=6}
N <- all_contacts2 %>% 
  filter(year <2018,
         year > 2006) %>% 
  nrow()

all_contacts2 %>% 
  filter(Type != "To be coded",
         year <2018,
         year > 2006) %>%  
    mutate(total = n()) %>% 
  group_by(Type, total, type) %>% 
  summarise(nT = n()) %>% 
  mutate(percent = paste0(nT, " = ", 100*round(nT/total, 2), "%"),
         Type = str_c(Type, "\n    ", percent)) %>% 
  ungroup() %>% 
  #distinct(type, Type, nT)
  ggplot() + 
  geom_col(alpha = .7,aes(x = type, fill = Type, y = nT/1000), position ="stack") + 
  coord_flip() + 
  scale_y_continuous(breaks = seq(0,500, 50)) + 
  labs(x = "",
       fill = "",
       y = paste("Number of Contacts (Thousands)\nN =", N),
       title = "") +
  #theme_void() + 
  theme(panel.border = element_blank(),
        panel.grid.major.y = element_blank(),
        axis.ticks = element_blank(),
        axis.text.x.top = element_text())
```

---

## Requests by institutional position

The first plot is the contacts we have coded. The second assumes these ratios hold for uncoded letters.

```{r chairs, fig.cap="Change in Levels of Constituency Service and Policy Work as Legislators Gain Power", fig.width=4, fig.height=3}

chairs <- all_contacts %>% distinct(icpsr, chair, year) 

d %<>% left_join(chairs) %>% 
  mutate(chair = chair %>%
           replace_na(0),
         Chair = ifelse(chair == 1, "Committee Chair", " Non-Chair"))

chair <- d %>% 
  group_by(type, year, icpsr, Chair) %>% 
  summarise(n = sum(per_icpsr_chamber_year_agency_type)) %>%
  group_by(type, Chair) %>% 
  summarise(mean = mean(n)) %>% 
  ungroup() %>%
  filter(!is.na(type))

chair %>% 
  ggplot()  + 
  aes(x = type, y = mean) +
  geom_col(alpha = .7,position = "dodge") + 
  facet_wrap("Chair") + 
  labs(x = "", # "Type of Legislator Request to Agency",
       y = "Average Requests per Year") +
  theme(panel.grid.major.x = element_blank(),
        panel.border = element_blank(),
        axis.ticks.x = element_blank())




chair %>% 
  # assuming consistant proportions to uncoded data 
  mutate(mean = mean*multiplier) %>% 
  ggplot()  + 
  aes(x = type, y = mean) +
  geom_col(alpha = .7,position = "dodge") + 
  facet_wrap("Chair") + 
  labs(x = "Type of Legislator Request to Agency",
       y = "Average Requests per Year") +
  theme(panel.grid.major.x = element_blank(),
        panel.border = element_blank(),
        axis.ticks.x = element_blank())
```





## Level

### Member-level

TODO 

- [ x ] members.Rdata going back to most senior member's first Congress in "data/nominate.Rdata"
- [ x ] what to do with party and chamber switchers? Drop them from counts.

```{r level}

#load(here::here('data', 'dcounts_min.Rdata'))

##creating the aggregate count variable
## one obs per agency, member, year 
d <- dcounts_min %>% 
  group_by(agency, icpsr, chamber, year) %>% 
  summarise(perYear = sum(per_icpsr_chamber_year_agency_type)) 

# dcounts_min %>% 
#   mutate(type2 = ifelse(TYPE %in% c(1,2,3), "policy", NA ),
#          type2 = ifelse(TYPE %in% c(4,5), "constituent", type2)) %>% 
#   group_by(type2, agency, icpsr, chamber, year) %>% 
#   # 2-type counts 
#   mutate(perYear_type2 = sum(per_icpsr_chamber_year_agency_type),
#          # versions with NAs for models
#          perYear_con = ifelse(type2 == "constituent", perYear_type2),
#          perYear_pol = ifelse(type2 == "policy", perYear_type2))
#   

# constituency service
d_sub <- dcounts_min %>%
  filter(TYPE %in% c(1, 2, 3)) %>%
  group_by(agency, icpsr, chamber, year) %>%
  summarise(perYear_con = sum(per_icpsr_chamber_year_agency_type))

# policy
d_sub2<- dcounts_min %>%
  subset(TYPE %in% c(4, 5)) %>%
  group_by(agency, icpsr, chamber, year) %>%
  summarise(perYear_pol = sum(per_icpsr_chamber_year_agency_type))


d %<>% left_join(d_sub) %>% left_join(d_sub2)

# congress
d$congress <- year_congress(d$year)

d %<>% left_join(members %>% 
                 select(congress, icpsr, party,party_code, state_abbrev, district_code, nominate.dim1, presidents_party, female, chair, ranking_minority, party_leader, party_whip, majority, prestige, prestige_chair, yearelected, state), by = c('congress', 'icpsr'))

#FIXME this should all be in members data 
# nom <- read_csv(here::here('data', 'nominate_data.csv'))
nom2<- members %>% 
  group_by(icpsr) %>% 
  summarise(first_cong = min(congress))

nom2$first_year <- 1787 + 2*nom2$first_cong

df<- left_join(d, nom2, by ='icpsr' )
#/FIXME 

# Tenure vars 
df$tenure<- df$year - df$first_year
df$first<- ifelse(df$tenure==0, 1, 0)
df$second<- ifelse(df$tenure==1, 1, 0)
df$third<- ifelse(df$tenure==2, 1, 0)
df$fourth<- ifelse(df$tenure==3, 1, 0)
df$fifth<- ifelse(df$tenure==4, 1, 0)
df$sixth<- ifelse(df$tenure==5, 1, 0)

# colnames(agency_vars)
df %<>% 
  #select(-oversight_committee, -oversight_committee_chair) %>% #FIXME these should be the same
  left_join(agency_vars %>% 
                    select(agency, icpsr, chamber, year, oversight_committee,
                           oversight_committee_chair), by = c('agency', 'icpsr', 'year', 'chamber')
            )

df$icpsr_agency<- paste(df$agency, df$icpsr, sep='_')
df$agency_year<- paste(df$agency, df$year, sep='_')

# tenure 
df %<>% ungroup() %>% 
  group_by(icpsr) %>% 
  mutate(max_year = max(tenure)) 

df$survive <- ifelse((df$chamber=='House' & df$max_year>1)| (df$chamber=='Senate' & df$max_year>5),1, 0 )


##purging repeated values 
#FIXME repeats are probably chamber switchers
df %<>% 
  add_count(icpsr, year, agency, chamber, 
            name = "n") 

#FIXME !!! 
doubles <- filter(df, n>1) # no doubles (doubles were chamber-switchers)

doubles %>% kablebox()

# drop doubles 
df %<>% filter(n<2) 


# LEVEL MODELS

df %<>% 
  # mutate(agency_year) %>% 
  mutate(lpyear = log(perYear + 1))
```

---

### District-level

- [ ] Were most maps in place by 2011?

```{r district}
####
# Redistricting? were most maps in place by 2011?
decade<- case_when(df$year < 2011 ~ '0', 
                   df$year > 2010 ~ '1')

state_dist<- case_when(df$chamber=='Senate'~ paste(df$state,
                                                    df$district_code, 
                                                    sep='_' ), 
                       df$chamber =='House'~ paste(paste(df$state, 
                                                          df$district_code, 
                                                          sep='_'), 
                                                    decade,
                                                    sep='_'))




df$state_dist<- state_dist

perDist<- df %>% 
  group_by(year, state_dist, icpsr, chamber, tenure, state) %>% 
  summarise(perYear = sum(perYear)) %>%
  distinct()



## Now, we want to identify when there is a new member in a district.  To do this, we look for changes in the icpsr number
perDist$new_member<- ifelse(perDist$tenure==0, 1, 0)

perDist$second_year<- ifelse(perDist$tenure==1, 1, 0)
perDist$third_year<- ifelse(perDist$tenure==2, 1, 0)
perDist$fourth_year<- ifelse(perDist$tenure==3, 1, 0)
perDist$fifth_year<- ifelse(perDist$tenure==4, 1, 0)
perDist$sixth_year<- ifelse(perDist$tenure==5, 1, 0)


state_level<- perDist %>% group_by(state, year) %>% 
  summarise(numpers = n(), 
            sumYear = sum(perYear), 
            mean_new = mean(new_member)) 

state_new <- ifelse(state_level$mean_new>0, 1, 0)

state_level$state_new <- state_new

perDist %<>% left_join(state_level %>% 
                         select(state_new, mean_new, state, year), 
                    by = c('state', 'year'))
#########################
# saved as DistrictLevel
########################
# save(perDist, file =  here::here("data", "perDist.Rdata"))
############################################
```

TODO

## Priority 

```{r ratio}
##creating the ratio variable 
d_rat <- df %>% 
  group_by(year, icpsr, chamber,
           prestige, prestige_chair, chair, ranking_minority, majority, presidents_party,
           first, second, third, fourth, fifth, sixth) %>% 
  # per member per year counts per type2
  summarise(perCon = sum(perYear_con), 
            perPol = sum(perYear_pol)) %>% 
  # ratio of con to pol 
  #FIXME switch? 
  mutate(ratio = perCon/(perCon + perPol))

# drop doubles
d_rat %<>% group_by(year, icpsr, chamber) %>% add_count(name = "n")

doubles_ratio <- filter(d_rat, n>1)

doubles_ratio %>% kablebox()

d_rat %<>% filter(n<2) 

############################################
# d_rat saved as ProportionContact.dta')
# save(d_rat, file =  here::here("data", "d_rat.Rdata"))
############################################

# RATIO MODEL 

```

TODO

## Joint Effect of Capacity and Priority 

We observe the total requests, $z$, and ratio, $r$, of policy work to constituency service. 
$z$ is the sum of policy requests $x$ and constituency service requests $y$. $r$ is $x/y$./

```{r}
r = .2

r2 = .31

z = 100

x = z*r
y = z-z*r


z2 = 120

x2 = z2*r2
y2 = z2-z2*r2
```

Combining model estimates for the shift in the level of requests and relative priority of policy work to constituency service, we see that even as the ratio of policy work increases, constituency service also significantly increases. 

These estimates are calculated by adding diff-in-diff regression coefficients for committee chairs' increased levels of requests to the baseline levels for non-chairs. We also adjust the ratio of policy work to constituency service based on the diff-in-diff regression coefficients for committee chairs' increased policy work ratio.

```{r chairs-est, fig.cap="Difference-in-Difference Estimates of Change in Levels of Constituency Service and Policy Work as Legislators Gain Power", fig.width=4, fig.height=3}
n_agencies <- dcounts_min$agency %>% unique() %>% length()

#FIXME replace with tidy model output 
# TABLE 1
level <- tribble(~term, ~estimate, ~std.error,
                 "chair", 0.206, 0.0951)

# per member across all agencies 
level$estimate <- level$estimate*n_agencies
level$std.error <- level$std.error*n_agencies

# ratio of policy work for non-chairs
base_ratio <- chair$mean[3]/chair$mean[1]

# level estimates with baseline ratio (for presenting level effects only)
level_con <- level %>% mutate(estimate = estimate*(1-base_ratio),
                               std.error = std.error*(1-base_ratio))

level_pol <- level %>% mutate(estimate = estimate*(base_ratio),
                               std.error = std.error*(base_ratio))


# Priority Table 
priority <- tribble(~term, ~estimate, ~std.error,
                 "chair", 0.0875, 0.0175)

# adjust level estimates with new ratio (joint effects )
new_ratio <- base_ratio + priority$estimate[1]

level_con <- level %>% mutate(estimate = estimate*(1-new_ratio),
                               std.error = std.error*(1-new_ratio))

level_pol <- level %>% mutate(estimate = estimate*(new_ratio),
                               std.error = std.error*(new_ratio))


#FIXME, include priority model uncertianty too
chair$std.error <- NA
# constituent error 
chair$std.error[2] <- level_con$std.error[1]
# policy error
chair$std.error[4] <- level_pol$std.error[1]


# chair mean = non-chair mean * level coef
# constituent estimate 
chair$mean[2] <- chair$mean[1] + (1 + level_con$estimate[1] )
# policy estimate
chair$mean[4] <- chair$mean[3] + (1+level_pol$estimate[1] )

chair_adjusted <- chair %>% 
  # assuming consistant proportions to uncoded data 
  mutate(mean = mean*multiplier) %>%
  # baseline = non-chairs mean
  mutate(baseline = ifelse(Chair == "Committee Chair", NA, mean) ) %>%
  fill(baseline) %>%
  # point estimates and uncertiatty only for chair estimates 
  mutate(estimate = ifelse(Chair == "Committee Chair", mean, NA)) %>% 
  mutate(std.error = ifelse(Chair == "Committee Chair", std.error, NA)) 

chair_adjusted %>% 
  #mutate(Chair = ifelse() )
  ggplot()  + 
  aes(x = type, y = mean) +
  geom_col(alpha = .7, position = "dodge") + 
  geom_hline(aes(yintercept = baseline), linetype = 2) + 
  geom_pointrange(aes(y = estimate,
                      ymin = mean-1.96*std.error,
                      ymax = mean+1.96*std.error)) + 
  facet_wrap("Chair") + 
  labs(x = "", #Type of Legislator Request to Agency",
       y = "Average Requests per Year") +
  theme(panel.grid.major.x = element_blank(),
        panel.border = element_blank(),
        axis.ticks.x = element_blank())


chair_adjusted %<>% mutate(baseline = ifelse(type =="Constituency\nService", baseline+ 12.4, baseline))


# stacked to show ratio with PERCENTS 
chair_adjusted %>% 
  #mutate(Chair = ifelse() )
  ggplot()  + 
  aes(x = Chair, y = mean, fill = type) +
  geom_col(alpha = .7, position = "fill") +  
  facet_wrap("Chair", scales = "free_x") + 
  labs(x = "", #Type of Legislator Request to Agency",
       y = "Share of Requests per Year",
       fill = "") +
  theme(panel.grid.major.x = element_blank(),
        axis.text.x = element_blank(),
        panel.border = element_blank(),
        axis.ticks.x = element_blank())

# stacked to show ratio + free scales 
chair_adjusted %>% 
  #mutate(Chair = ifelse() )
  ggplot()  + 
  aes(x = Chair, y = mean, fill = type) +
  geom_col(alpha = .7, position = "stack") + 
  #geom_hline(aes(yintercept = baseline), linetype = 2) + 
  #geom_pointrange(aes(y = estimate,
                      #ymin = mean-1.96*std.error,
                      #ymax = mean+1.96*std.error)) + 
  facet_wrap("Chair", scales = "free") + 
  #scale_y_
  labs(x = "", #Type of Legislator Request to Agency",
       y = "Average Requests per Year",
       fill = "") +
  theme(panel.grid.major.x = element_blank(),
        axis.text.x = element_blank(),
        panel.border = element_blank(),
        axis.ticks.x = element_blank())

# stacked to show ratio + CI
chair_adjusted %>% 
  #mutate(Chair = ifelse() )
  ggplot()  + 
  aes(x = Chair, y = mean, fill = type) +
  geom_col(alpha = .7, position = "stack") + 
  geom_hline(aes(yintercept = baseline), linetype = 2) + 
  geom_pointrange(aes(y = estimate,
                      ymin = mean-1.96*std.error,
                      ymax = mean+1.96*std.error)) + 
  facet_wrap("Chair", scales = "free") + 
  labs(x = "", #Type of Legislator Request to Agency",
       y = "Average Requests per Year",
       fill = "") +
  theme(panel.grid.major.x = element_blank(),
        axis.text.x = element_blank(),
        panel.border = element_blank(),
        axis.ticks.x = element_blank())
```

The baseline level (non-chairs) is `r chair_adjusted$mean[1]` constituency service requests and `r chair_adjusted$mean[3]` policy requests per year. 

The baseline ratio (for non-chairs) of policy work to constituency service is `r base_ratio`. Adding the model coefficient from the difference in difference model of shifting priorities yields a new ratio of `r new_ratio`.

The model-estimated level for committee chairs is `r chair_adjusted$mean[2]` constituency service requests and `r chair_adjusted$mean[4]` policy requests per year. 



#TODO

- [ ] intercoder agrement for USTR

- [ ] y-axis label and remove the title from inequality figure

- [ ] facet distribution across types by policy and constituent, probably coord flip as well

- [ x ] remove the title from state pop figure


