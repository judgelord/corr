---
title: "Replication"
subtitle: "Unequal Representation: Evidence from a Census of Legislator Contacts with US Federal Agencies"
output:
    html_document:
      highlight: zenburn
      toc: true
      toc_float: true
      code_folding: hide
    #   toc: true
    #   keep_tex: true
    # pdf_document:
      header-includes:
       - \usepackage{subfig}

editor_options: 
  chunk_output_type: console
---


```{r global.options, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      cache = FALSE, 
                      fig.width=4.5, 
                      fig.height = 3.5,
                      split = T,
                      fig.align = 'center', 
                      fig.path='figs/',
                      fig.retina = 1,
                      warning=FALSE, 
                      message=FALSE)



library(modelsummary)
library(marginaleffects)
library(fixest)
library(tidyverse)
library(magrittr)
library(tidytext)
library(xml2)
library(knitr)
library(kableExtra)
library(here)
library(ggrepel)

# library(lfe)

library(ggplot2); theme_set(theme_bw())
  options(
    ggplot2.continuous.color = "viridis",
    ggplot2.continuous.fill = "viridis"
  )
  scale_color_discrete <- function(...)
    scale_color_viridis_d(..., direction = -1)
  scale_fill_discrete <- function(...)
    scale_fill_viridis_d(..., direction = -1)
  
  
kablebox <- . %>%  
  head(100) %>%
  knitr::kable() %>% 
  kable_styling() %>% 
  scroll_box(height = "200px")

kablebox_long <- . %>% 
  head(100) %>% 
  knitr::kable() %>% 
  kable_styling() %>% 
  scroll_box(height = "500px")

# smarter number functions
smart_number <- function(n, ...) {
  # if non-int below ten, return as is
  if ( (n != as.numeric(n)) ) {
    return(n)
  } else 
    # if non-int above ten, return number()
    if (abs(n) >= 10 | as.numeric(n) != as.integer(n) ) {
      return( prettyNum(n, big.mark = ",") )#scales::number(n, big.mark = ",", ...))
    } else 
      # if int below 10, print english
      if (abs(n) < 10 & as.numeric(n) == as.integer(n) ) {
        return(english::english(n, ...))
      } else 
        stop("??")
}



# inline formatting 
knit_hooks$set(inline = function(x) {
  if (is.na(as.numeric(x))) {
    return(x)
    } else 
      x <- as.numeric(x)
      # omit years 
    if (x > 2021 | x < 1980)  {
      return(smart_number(x))
      } else 
        return(x) #prettyNum(x, big.mark = ",") # 
})
```

# Replication data

From `code/replication.R`, which starts with the main data file (`dcounts_min.Rdata`) and makes transformations for three sets of models: 

1. counts per member-year (dcounts_tenure.Rdata/AgencyComm.dta)
2. ratio per member-year (dcounts_ratio.Rdata/ProportionContact.dta)
3. counts per district-year (dcounts_per_district.Rdata, DistrictLevel.dta)

The same three datasets are used in Replication.do

```{r data}
load(here::here("data", "dcounts_tenure.Rdata"))
load(here::here("data", "dcounts_ratio.Rdata"))
load(here::here("data", "dcounts_per_district.Rdata"))
load(here::here("data" , "members.Rdata"))


# names for table 
dcounts_tenure %<>% 
  mutate(Legislator = icpsr,
         Legislator_x_Agency = icpsr_agency,
         Year_x_Agency = agency_year)

dcounts_tenure %>% group_by(agency) %>% summarise(n = perYear %>% sum()) %>% arrange(-n) %>% kablebox()

dcounts_tenure %>% group_by(Legislator_x_Agency) %>% summarise(n = perYear %>% sum()) %>% arrange(-n) %>% kablebox()
```

```{r count_by_tenure, eval=FALSE}
dcounts_tenure2 <- dcounts_tenure %>%
  group_by(icpsr, agency, perYear, perYear_con, perYear_policy, year) %>% 
  mutate(sum = sum(first, second, third, fourth, fifth, sixth),
         more = ifelse(sum == 0, 1,0)) %>% 
    pivot_longer(cols = c("first", "second", "third", "fourth", "fifth", "sixth", "more")) %>% 
  filter(value == 1) %>% 
  distinct(icpsr, agency, year, perYear, perYear_con, perYear_policy, name) %>% 
    # clean up for presentation
    mutate(year_in_congress = name %>% 
             str_replace("more", "7\nor more") %>% 
             str_replace("sixth", "6") %>% 
             str_replace("fifth", "5") %>% 
             str_replace("fourth", "4") %>% 
             str_replace("third", "3") %>% 
             str_replace("second", "2") %>% 
             str_replace("first", "1") 
             ) %>% 
    ungroup() %>% 
  group_by(icpsr, year, year_in_congress) %>% 
      select(starts_with("per")) %>% 
  # sum across agencies 
  summarise(across(starts_with("per"), sum)) %>% 
  ungroup() 

dcounts_tenure2 %>% ungroup() %>% 
  #group_by(icpsr) %>% 
  tally(perYear)
```



### Values to predict at

The most frequent legislator agency pair: McCain x VA with 2159 letters!

<!--The most frequent year at the VA: 2018-->

The average number of letters per agency is 1.29

For predictions, we need an average member-year-agency triad. The average is 73 letters per legislator per year, a little over one letter per agency per year. The first table below shows the members who averaged 73, entered congress between 2007 and 2011, were observed in our data for at least seven years, and most often submitted exactly one letter to an agency. For realism, this person would ideally, at some point, become a chair. Phil Roe meets this last criterion. The IRS is a fairly modal agency and one of the agencies to which Phil Roe submitted one letter in 2015, so predictions are at Phil Roe X IRS X 2015. Other legislators, years, and agencies are simply intercept shifts. 


```{r values, fig.width=5, fig.height=3}
modal <- dcounts_tenure %>% 
  group_by(icpsr) %>% 
  filter(first_year > 2006, first_year < 2013, max_year > 6) %>% 
  mutate(Chair = sum(chair, na.rm = T) >1) %>% 
  group_by(icpsr, year) %>%
  mutate(perLeg = sum(perYear)) %>% 
  filter(perYear == 1, perLeg == 73 ) %>% 
  select(perAgency = perYear, perLeg, icpsr, icpsr_agency, agency_year, first_year, max_year, Chair) %>% 
  distinct() %>% 
  ungroup() %>% left_join(members %>% select(bioname, icpsr))

modal %>%
  mutate(average = perLeg) %>% 
  count(average, bioname, first_year, max_year, Chair, sort = T, name = "agency_year_count == 1") %>% 
  kablebox()

modal %<>% filter(Chair)

dcounts_tenure %>% 
    #filter(first_year > 2006, first_year < 2013, max_year > 6) %>% 
  group_by(icpsr, year) %>% 
  mutate (perLegislator = sum(perYear)) %>% 
  ungroup() %>% 
  mutate(meanLeg = mean(perLegislator),
         meanYear = mean(perYear)) %>%
  filter( abs(perLegislator - meanLeg) < 10,   
          abs(perYear - meanYear) < 10 )  %>%
  ggplot() +
  aes(x = perYear, y = perLegislator) + 
    geom_jitter() + 
  geom_vline(aes(xintercept = meanYear), color = "blue") + 
  geom_hline(aes(yintercept = meanLeg), color = "blue") + 
  geom_text_repel(aes(label = ifelse(icpsr_agency %in% modal$icpsr_agency & agency_year %in% modal$agency_year & perLegislator == 73, icpsr_agency, NA) ),
                  color = "red", box.padding = 0.5, max.overlaps = Inf) + 
  labs(x = "Contacts per Legislator per Agency per Year",
       y = "Contacts per Legislator per Year")

modal %>%
  distinct(perAgency, bioname, icpsr_agency, agency_year) %>% 
  kablebox()

# other variable means
# dcounts_tenure %>% summarise(across(everything(), mean_or_mode)) %>% kablebox()


values <- tidyr::expand(dcounts_tenure,
                        agency = "Treasury_IRS",
                        chair = chair, 
                        ranking_minority	= FALSE, 
                        prestige = TRUE, 
                        first = FALSE,
                        second = FALSE,
                        third = FALSE,
                        fourth = FALSE,
                        fifth = FALSE, 
                        sixth = FALSE,
                        Legislator_x_Agency = "Treasury_IRS_20947",
                        Year_x_Agency = "Treasury_IRS_2015",
                        Legislator = "20947",
                        Year = "2015",
                        majority = TRUE,
                        presidents_party = presidents_party
                   ) %>% 
  drop_na(majority, chair)

values_max <- tidyr::expand(dcounts_tenure,
                        agency = "VA",
                        chair = chair, 
                        ranking_minority	= FALSE, 
                        prestige = TRUE, 
                        first = FALSE,
                        second = FALSE,
                        third = FALSE,
                        fourth = FALSE,
                        fifth = FALSE, 
                        sixth = FALSE,
                        Legislator_x_Agency = "VA_15039",
                        Year_x_Agency = "VA_2018",
                        Legislator = "15039",
                        Year = "2018",
                        majority = TRUE,
                        presidents_party = presidents_party
                   ) %>% 
  drop_na(majority, chair)

values_tenure <- tidyr::expand(dcounts_tenure,
                        agency = "Treasury_IRS",
                        chair = chair, 
                        ranking_minority	= FALSE, 
                        prestige = TRUE, 
                        first = first,
                        second = second,
                        third = third,
                        fourth = fourth,
                        fifth = fifth, 
                        sixth = sixth,
                        Legislator_x_Agency = "Treasury_IRS_20947",
                        Year_x_Agency = "Treasury_IRS_2015",
                        Legislator = "20947",
                        Year = "2015",
                        majority = TRUE,
                        presidents_party = TRUE
                   ) 


values_tenure_max <- tidyr::expand(dcounts_tenure,
                        agency = "VA",
                        chair = FALSE, 
                        ranking_minority	= FALSE, 
                        prestige = TRUE, 
                        first = first,
                        second = second,
                        third = third,
                        fourth = fourth,
                        fifth = fifth, 
                        sixth = sixth,
                        Legislator_x_Agency = "VA_15039",
                        Year_x_Agency = "VA_2018",
                        Legislator = "15039",
                        Year = "2018",
                        majority = TRUE,
                        presidents_party = TRUE
                   ) 
```


```{r}
# helper functions 

ggchair <- function(predicted = predicted) {
  
  predicted$chair %<>% str_replace("0", "Not Chair") %>% str_replace("1", "Chair")
  
  predicted$presidents_party %<>% str_replace("0", "Not President's Party") %>% str_replace("1", "President's Party")

predicted %>%  
  ggplot() + 
  aes(x = "", 
      y = predicted, 
      fill = chair,
      shape = chair,
      color = chair,
      ymin = predicted - 1.96*std.error,
      ymax = predicted + 1.96*std.error) + 
  geom_pointrange(position =  position_dodge(width = -.5)  )  + 
  scale_fill_viridis_d(begin = 0, end = .6, option = "cividis") +
  scale_color_viridis_d(begin = 0, end = .6, option = "cividis") +
      theme_minimal() + 
  theme(panel.border  = element_blank(),
        panel.grid.major.x = element_blank()) + facet_grid(. ~ presidents_party) 
}


ggtenure <- function(predicted = predicted) {
  
predicted %<>%
  # drop estimates from impossible values
      group_by(rowid, predicted, std.error, chair) %>% 
  mutate(sum = sum(first, second, third, fourth, fifth, sixth),
         more = ifelse(sum == 0, 1,0)) %>% 
    filter(sum < 2) %>% 
    pivot_longer(cols = c("first", "second", "third", "fourth", "fifth", "sixth", "more")) %>% 
    select(name, value) %>% 
    filter(value == 1) %>% 
    # clean up for presentation
    mutate(year_in_congress = name %>% 
             str_replace("more", "7\nor more") %>% 
             str_replace("sixth", "6") %>% 
             str_replace("fifth", "5") %>% 
             str_replace("fourth", "4") %>% 
             str_replace("third", "3") %>% 
             str_replace("second", "2") %>% 
             str_replace("first", "1") 
             ) %>% 
    ungroup()
  
# Ideally, we could plot against data, but there is so much variation that you can no longer distinguish differences in predicted values 
# predicted %<>% full_join(dcounts_tenure2 %>% mutate(predicted = NA))
  
predicted %<>% filter(chair == 0 | name %in% c("sixth", "more"))

  predicted$chair %<>% str_replace("0", "Not Chair") %>% str_replace("1", "Chair")
  

predicted %>%  
  ungroup() %>% 
  ggplot() + 
  aes(x = year_in_congress, 
      y = predicted, 
      shape = chair,
      color = chair,
      ymin = predicted - 1.96*std.error,
      ymax = predicted + 1.96*std.error) + 
  geom_pointrange(position =  position_dodge(width = -.3)  )  + 
  scale_fill_viridis_d(begin = 0, end = .6, option = "cividis") +
  scale_color_viridis_d(begin = 0, end = .6, option = "cividis") +
      theme_minimal() + 
  theme(panel.border  = element_blank(),
        panel.grid.major.x = element_blank()) 
  
}
```

---

# Counts per member per year

Clustering standard errors at the legislator level:

["Clustering on the panel variable produces an estimator of the VCE that is robust to cross-sectional heteroskedasticity and within-panel (serial) correlation that is asymptotically equivalent to that proposed by Arellano (1987)"](https://www.stata.com/manuals13/xtxtreg.pdf)

Replicated using `fixest::feglm` here and `xtreg` in Replication.do.
See more about robust (clustered) standard errors with fixed effects are calculated by `fixest` [here](https://lrberge.github.io/fixest/articles/standard_errors.html) and by  `xtreg` [here](https://www.stata.com/manuals13/xtxtreg.pdf).

```{r cm}
# Coef Map
cm = c("chair" = "Committee Chair",
       "ranking_minority" = "Ranking Member",
       "prestige" = "Prestige Committee",
       "first" = "First Year",
       "second" = "Second Year",
       "third" = "Third Year",
       "fourth" = "Fourth Year",
       "fifth" = "Fifth Year",
       "sixth" = "Sixth Year",
       "majority" = "Majority",
       "presidents_party" = "President's Party",
       "Legislator" = "Legislator", 
       "Agency" = "Agency",
       "FE: icpsr_agency" = "Legislator × Agency Fixed Effects",
       "icpsr_agency" = "Legislator × Agency Fixed Effects")


setFixest_dict(cm)

# table formatting 
format_table <- . %>% row_spec(row = 1, bold = T, hline_after = TRUE) %>% 
      kable_styling(font_size = 11) %>% 
                    #full_width = TRUE, 
                    #latex_options = c("repeat_header")) %>%
  str_replace("Num.Obs.", "Observations") %>% 
  str_replace("Std.Errors", "Robust/Clustered Std. Errors") %>% 
  str_replace("FE: Legislator_x_Agency", "Legislator x Agency FE") %>%
  str_replace("FE: Year_x_Agency", "Year x Agency FE") %>% 
  str_replace("FE: Year", "Year Fixed Effects") %>% 
  str_replace("FE: Legislator", "Legislator Fixed Effects") %>%
    str_replace_all("X|✓", "\\\\\\checkmark") 
```


---

## Total Letters 

- Figures: `figs/m-total-[1:4].png`

```{r m-total,  fig.show="hold", out.width="50%", fig.height=4.5, fig.cap= "Total Letters", fig.subcap= ""}
testing = F

# paper table 
# 1 
# cross-sectional 
m_total_cross <-feglm (perYear ~ 
                         chair + ranking_minority + prestige + 
                    first + second + third + fourth + fifth + sixth + 
                    majority + presidents_party | Legislator_x_Agency,
                    cluster = "Legislator", 
           data = dcounts_tenure)

if(testing){modelsummary(m_total_cross, gof_omit = "R.*", coef_omit = "(Intercept)")}

coefplot(m_total_cross, horiz = T, drop = "(Intercept)") 



# 2
m_total_dnd <-feglm (perYear ~ 
                       chair + ranking_minority + prestige + 
                    first + second + third + fourth + fifth + sixth + 
                    majority + presidents_party | Year_x_Agency + Legislator_x_Agency, 
                    cluster = "Legislator",
                    # ALT vcov = hetero ~ ssc(cluster.adj = TRUE),
           data = dcounts_tenure)

if(testing){modelsummary(m_total_dnd, gof_omit = "R.*", coef_omit = "(Intercept)")}

coefplot(m_total_dnd, horiz = T) 


# 3
m_total_2nd <-feglm (perYear ~ 
                       chair + ranking_minority + prestige + 
                    first + second + third + fourth + fifth + sixth + 
                    majority + presidents_party | Year_x_Agency + Legislator_x_Agency, 
                    cluster = "Legislator", 
           data = dcounts_tenure %>% filter(survive == 1))

if(testing){modelsummary(m_total_2nd, gof_omit = "R.*", coef_omit = "(Intercept)")}
coefplot(m_total_2nd, horiz = T) 


# 4
m_logtotal_dnd <-feglm (log(perYear + 1) ~ 
                          chair + ranking_minority + prestige + 
                    first + second + third + fourth + fifth + sixth + 
                    majority + presidents_party | Year_x_Agency + Legislator_x_Agency, 
                    cluster = "Legislator", 
           data = dcounts_tenure)

if(testing){modelsummary(m_logtotal_dnd, gof_omit = "R.*", coef_omit = "(Intercept)")}

coefplot(m_logtotal_dnd, horiz = T) 


```

### Total Letters Table 

- Table: `tables/models_total.tex` (sans stars)


```{r models_total}
models_total <- list(
  "1" = m_total_cross,
  "2" = m_total_dnd,
  "3"  =  m_total_2nd,
  "4" = m_logtotal_dnd
)

rows <- tibble(
  term = c("Dependent Variable", "All Legislators", "Served At Least 2nd Term"),
  `1` = c("Count", "✓", ""),
  `2` =c("Count", "✓", ""),
  `3`  = c("Count", "", "✓"),
  `4` = c("Log(Count+1)", "✓", "") #"✓"
)

attr(rows, 'position') <- c(0, 24,25)


# HTML
modelsummary(models_total, stars = T, 
             add_rows = rows, 
             coef_map = cm,
             gof_omit = "R.*|AIC|BIC|Log.*",
             coef_omit = "(Intercept)")

# LaTeX 
modelsummary(models_total, # stars = T, 
             add_rows = rows,               
             coef_map = cm, 
             gof_omit = "R.*|AIC|BIC|Log.*", 
             coef_omit = "(Intercept)",
             output = "latex",
             title = "The Effect of Expierence and Institutional Power on Legislator Contacts", 
             notes = list("Column 1 shows average differences across committee assignments and years in Congress.",
                          "Column 2 presents difference-in-differences estimates",
                          "Column 3 subsets to legislators who serve at least 3 years in Congress.",
                          "Column 4 takes the Log of the counts + 1 as the dependent variable.") %>% rev() ) %>% 
  format_table() %>%
  write_lines(file = here::here("tables", "models_total.tex") )


beta <- m_total_dnd$coefficients %>%round(3) %>% as_tibble(rownames = "beta") %>% pivot_wider(names_from = beta)

se <- m_total_dnd$se %>%round(3) %>% as_tibble(rownames = "se") %>% pivot_wider(names_from = se)
```

To address potential confounding in across-legislator comparisons, the estimates from Model 2 (Column 2 of Table `\ref{tab:models_total}`) provide the estimated effects from the difference-in-differences specification in Equation `\ref{e:diff1}`. Across all measures of institutional power, we find that more power increases the number of requests that legislators make. Consider first the effect of being a committee chair. We estimate that becoming a committee chair causes an increase of `r beta$chair`  requests `\textit{per agency}` (95-percent confidence interval [`r beta$chair - se$chair*1.96`, `r beta$chair + se$chair*1.96`]). Across all 90 agencies, this represents an increase of approximately `r (beta$chair*90) %>% round(0)` additional requests per year, `r (beta$chair / mean(dcounts_tenure$perYear) ) %>% round(3)*100 ``\%` of the average number of requests per year in our data. There is a smaller increase for individuals who become ranking members and those who join a Prestige Committee, though the increase is statistically significant for the prestige committee. Becoming a ranking member of a committee causes an increase of `r beta$ranking_minority` contacts per agency while joining a prestige committee causes a `r beta$chair` per agency increase in the number of contacts a member of Congress makes.

We estimate that the experience gained between the first and second year in Congress causes an increase of `r beta$second-beta$first`  requests `\textit{per agency}`.  The experience gained between the first and seventh year causes an increase of `r -beta$first` per agency. Across all 90 agencies, this represents an increase of approximately `r (-beta$first*90) %>% round(0)` additional requests per year, `r ((-beta$first) / mean(dcounts_tenure$perYear) ) %>% round(3)*100 ``\%` of the average number of requests per year in our data. There is a smaller increase after the second year. The experience gained between the second and seventh year causes an increase of `r -beta$second` per agency, an increase of approximately `r (-beta$second*90) %>% round(0)` additional requests per year, `r ((-beta$first) / mean(dcounts_tenure$perYear) ) %>% round(3)*100 ``\%` of the average number of requests per year in our data. 

### Predictions 

- Figures: `figs/m-total-predicted-[1:4].png`


```{r m-total-predicted,  fig.show="hold", out.width="50%", fig.cap= "Total", fig.subcap= ""}
predicted <- predictions(m_total_cross,
                         newdata = values)

# As a plot
predicted %>%
    mutate(predicted = predicted*90,
         std.error = std.error*90) %>%
  ggchair() + 
  labs(title = "Predicted Number of Total Letters per Year\n(Cross-Sectional)",
       x = "",
       y = "Predicted Number of Total Letters",
       fill = "",
       color = "",
       shape = "") 

# tenure
predicted <- predictions(m_total_cross,
                         newdata = values_tenure)

predicted %>%
    mutate(predicted = predicted*90,
         std.error = std.error*90) %>% 
ggtenure() +
  labs(title = "Predicted Number of Total Letters\n(Cross-Sectional)",
       x = "Year in Congress",
       y = "Predicted Number of Letters",
       fill = "",
       color = "",
       shape = "") 


# DND 
predicted <- predictions(m_total_dnd,
                         newdata = values)


# As a plot
predicted %>%
    mutate(predicted = predicted*90,
         std.error = std.error*90) %>%
  ggchair() + 
  labs(title = "Predicted Number of Total Letters per Year\nDifference in Differences (Within Legislator)",
       x = "",
       y = "Predicted Number of Letters",
       fill = "",
       color = "",
       shape = "") 

# tenure
predicted <- predictions(m_total_dnd,
                         newdata = values_tenure)

predicted %>%
    mutate(predicted = predicted*90,
         std.error = std.error*90) %>%
ggtenure() +
    geom_line(aes(x = as.numeric(year_in_congress %>% str_sub(1,1)))) + 
  labs(title = "Predicted Number of Total Letters\nDifference in Differences (Within Legislator)",
       x = "Year in Congress",
       y = "Predicted Number of Letters",
       fill = "",
       color = "",
       shape = "") 
```


## Constituency Service Letters

DV: Only letters coded as constituency service letters

- Figures: `figs/m-con-[1:4].png`

```{r m-con,  fig.show="hold", out.width="50%", fig.height=4.5, fig.cap="Constituency Service Letters", fig.subcap= c("1","2","3","4")}
testing = F

m_con_cross <-feglm (perYear_con ~ 
                       chair + ranking_minority + prestige + 
                    first + second + third + fourth + fifth + sixth + 
                    majority + presidents_party,
                    cluster = "Legislator", 
           data = dcounts_tenure)

if(testing){modelsummary(m_con_cross, gof_omit = "R.*", coef_omit = "(Intercept)")}

coefplot(m_con_cross, horiz = T, drop = "(Intercept)") 



# 2
m_con_dnd <-feglm (perYear_con ~ 
                     chair + ranking_minority + prestige + 
                    first + second + third + fourth + fifth + sixth + 
                    majority + presidents_party | Year_x_Agency + Legislator_x_Agency, 
                    cluster = "Legislator",
           data = dcounts_tenure)

if(testing){modelsummary(m_con_dnd, gof_omit = "R.*", coef_omit = "(Intercept)")}
coefplot(m_con_dnd, horiz = T) 


# 3
m_con_2nd <-feglm (perYear_con ~ 
                     chair + ranking_minority + prestige + 
                    first + second + third + fourth + fifth + sixth + 
                    majority + presidents_party | Year_x_Agency + Legislator_x_Agency, 
                    cluster = "Legislator", 
           data = dcounts_tenure %>% filter(survive == 1))

if(testing){modelsummary(m_tenure_2nd, gof_omit = "R.*", coef_omit = "(Intercept)")}
coefplot(m_con_2nd, horiz = T) 


# 4
m_logcon_dnd <-feglm (log(perYear_con + 1) ~ 
                        chair + ranking_minority + prestige + 
                    first + second + third + fourth + fifth + sixth + 
                    majority + presidents_party | Year_x_Agency + Legislator_x_Agency, 
                    cluster = "Legislator", 
           data = dcounts_tenure)

if(testing){modelsummary(m_logcon_dnd, gof_omit = "R.*", coef_omit = "(Intercept)")}

coefplot(m_logcon_dnd, horiz = T) 
```

### Constituency Letters Table

- Table: `tables/models_con.tex` (sans stars)

```{r models_con}
models_con <- list(
  "1" = m_con_cross,
  "2" = m_con_dnd,
  "3"  =  m_con_2nd,
  "4" = m_logcon_dnd
)


modelsummary(models_con, stars = T, 
             add_rows = rows, 
             coef_map = cm,
             gof_omit = "R.*|AIC|BIC|Log.*", 
             coef_omit = "(Intercept)")

modelsummary(models_con, # stars = T, 
             add_rows = rows,               
             coef_map = cm, 
             gof_omit = "R.*|AIC|BIC|Log.*", 
             coef_omit = "(Intercept)",
             output = "latex",
             title = "The Effect of Expierence and Institutional Power on Constituency Service", 
             notes = list("Column 1 shows average differences across committee assignments and years in Congress.",
                          "Column 2 presents difference-in-differences estimates",
                          "Column 3 subsets to legislators who serve at least 3 years in Congress.",
                          "Column 4 takes the Log of the counts + 1 as the dependent variable."))%>% 
  format_table() %>%
  write_lines(file = here::here("tables", "models_con.tex") )

beta <- m_con_dnd$coefficients %>%round(3) %>% as_tibble(rownames = "beta") %>% pivot_wider(names_from = beta)

se <- m_con_dnd$se %>%round(3) %>% as_tibble(rownames = "se") %>% pivot_wider(names_from = se)
```

To address potential confounding in across-legislator comparisons, the estimates from Model 2 (Column 2 of Table `\ref{tab:models_con}`) provide the estimated effects from the difference-in-differences specification in Equation `\ref{e:diff1}`. More experience increases the level of constituency service that legislators provide. The effect of being a committee chair is positive, but not significant at the .05 level. 
We estimate that the experience gained between the first and second year in Congress causes an increase of `r beta$second-beta$first`  requests `\textit{per agency}`.  The experience gained between the first and seventh year causes an increase of `r -beta$first` per agency. Across all 90 agencies, this represents an increase of approximately `r (-beta$first*90) %>% round(0)` additional requests per year, `r ((-beta$first) / mean(dcounts_tenure$perYear_con) ) %>% round(3)*100 ``\%` of the average number of requests per year in our data. There is a smaller increase after the second year. The experience gained between the second and seventh year causes an increase of `r -beta$second` per agency, an increase of approximately `r (-beta$second*90) %>% round(0)` additional requests per year, `r ((-beta$first) / mean(dcounts_tenure$perYear_con) ) %>% round(3)*100 ``\%` of the average number of requests per year in our data. 


### Predictions 

- Figures: `figs/m-con-predicted-[1:4].png`

```{r m-con-predicted,  fig.show="hold", out.width="50%", fig.cap= "Constituency Service", fig.subcap= ""}
# A data frame of values at which to estimate probabilities:
predicted <- predictions(m_con_cross,
                         newdata = values)


# A plot
predicted %>%
  mutate(predicted = predicted*90,
         std.error = std.error*90) %>%
  ggchair() + 
  labs(title = "Predicted Number of Constituency Letters per Year\n(Cross-Sectional)",
       x = "",
       y = "Predicted Number of Letters",
       fill = "",
       color = "",
       shape = "") 

# tenure
predicted <- predictions(m_con_cross,
                         newdata = values_tenure)

predicted %>%
    mutate(predicted = predicted*90,
         std.error = std.error*90) %>%
ggtenure() +
    geom_line(aes(x = as.numeric(year_in_congress %>% str_sub(1,1)))) + 
  labs(title = "Predicted Number of Constituency Service Letters\n(Cross Sectional)",
       x = "Year in Congress",
       y = "Predicted Number of Letters",
       fill = "",
       color = "",
       shape = "") 



# Predictions for DND Plot
predicted <- predictions(m_con_dnd,
                         newdata = values)


# DND plot
predicted %>%
  mutate(predicted = predicted*90,
         std.error = std.error*90) %>%
  ggchair() + 
  labs(title = "Predicted Number of Constituency Service Letters per Year\nDifference in Differences (Within Legislator)",
       x = "",
       y = "Predicted Number of Letters",
       fill = "",
       color = "",
       shape = "") 

# tenure
predicted <- predictions(m_con_dnd,
                         newdata = values_tenure)

predicted %>%
    mutate(predicted = predicted*90,
         std.error = std.error*90) %>%
ggtenure() +
    geom_line(aes(x = as.numeric(year_in_congress %>% str_sub(1,1)))) + 
  labs(title = "Predicted Number of Constituency Service Letters\nDifference in Differences (Within Legislator)",
       x = "Year in Congress",
       y = "Predicted Number of Letters",
       fill = "",
       color = "",
       shape = "") 
```



## Policy Letters

Only using letters coded as constituent letters 

- Figures: `figs/m-policy-[1:4].png`

```{r m-policy,  fig.show="hold", out.width="50%", fig.height=4.5, fig.cap="Policy Letters", fig.subcap= c("1","2","3","4")}
testing = F

m_policy_cross <-feglm (perYear_policy ~ 
                          chair + ranking_minority + prestige + 
                    first + second + third + fourth + fifth + sixth + 
                    majority +  presidents_party,
                    cluster = "Legislator", 
           data = dcounts_tenure)

if(testing){modelsummary(m_policy_cross, gof_omit = "R.*", coef_omit = "(Intercept)")}

coefplot(m_policy_cross, horiz = T, drop = "(Intercept)") 



# 2
m_policy_dnd <-feglm (perYear_policy ~ 
                        chair + ranking_minority + prestige + 
                    first + second + third + fourth + fifth + sixth + 
                    majority + presidents_party | Year_x_Agency + Legislator_x_Agency, 
                    cluster = "Legislator",
           data = dcounts_tenure)

if(testing){modelsummary(m_policy_dnd, gof_omit = "R.*", coef_omit = "(Intercept)")}
coefplot(m_policy_dnd, horiz = T) 


# 3
m_policy_2nd <-feglm (perYear_policy ~ 
                        chair + ranking_minority + prestige + 
                    first + second + third + fourth + fifth + sixth + 
                    majority + presidents_party | Year_x_Agency + Legislator_x_Agency, 
                    cluster = "Legislator", 
           data = dcounts_tenure %>% filter(survive == 1))

if(testing){modelsummary(m_tenure_2nd, gof_omit = "R.*", coef_omit = "(Intercept)")}
coefplot(m_policy_2nd, horiz = T) 


# 4
m_logcon_dnd <-feglm (log(perYear_policy + 1) ~ 
                        chair + ranking_minority + prestige + 
                    first + second + third + fourth + fifth + sixth + 
                    majority + presidents_party | Year_x_Agency + Legislator_x_Agency, 
                    cluster = "Legislator", 
           data = dcounts_tenure)

if(testing){modelsummary(m_logcon_dnd, gof_omit = "R.*", coef_omit = "(Intercept)")}

coefplot(m_logcon_dnd, horiz = T) 
```

### Policy Letters Table

- Table: `tables/models_policy.tex` (sans stars)

```{r models_policy}
models_policy <- list(
  "1" = m_policy_cross,
  "2" = m_policy_dnd,
  "3"  =  m_policy_2nd,
  "4" = m_logcon_dnd
)


modelsummary(models_policy, stars = T, 
             add_rows = rows, 
             coef_map = cm,
             gof_omit = "R.*|AIC|BIC|Log.*", 
             coef_omit = "(Intercept)")

modelsummary(models_policy, # stars = T, 
             add_rows = rows,               
             coef_map = cm, 
             gof_omit = "R.*|AIC|BIC|Log.*", 
             coef_omit = "(Intercept)",
             output = "latex",
             title = "The Effect of Expierence and Institutional Power on Policy Work", 
             notes = list("Column 1 shows average differences across committee assignments and years in Congress.",
                          "Column 2 presents difference-in-differences estimates",
                          "Column 3 subsets to legislators who serve at least 3 years in Congress.",
             "Column 4 takes the Log of the counts + 1 as the dependent variable.") %>% rev() ) %>% 
  format_table() %>%
   write_lines(file = here::here("tables", "models_policy.tex") )
```

### Predictions 

- Figures: `figs/m-policy-predicted-[1:4].png`

```{r m-policy-predicted,  fig.show="hold", out.width="50%", fig.cap= "Policy", fig.subcap= ""}
predicted <- predictions(m_policy_cross,
                         newdata = values)

# As a plot
predicted %>%
  mutate(predicted = predicted*90,
         std.error = std.error*90) %>%
  ggchair() +
  labs(title = "Predicted Number of Policy Letters per Year\n(Cross-Sectional)",
       x = "",
       y = "Predicted Number of Letters",
       fill = "",
       color = "",
       shape = "") 

# tenure
predicted <- predictions(m_policy_cross,
                         newdata = values_tenure)

predicted %>%
    mutate(predicted = predicted*90,
         std.error = std.error*90) %>%
ggtenure() +
    geom_line(aes(x = as.numeric(year_in_congress %>% str_sub(1,1)))) + 
  labs(title = "Predicted Number of Policy Letters\n(Cross Sectional)",
       x = "Year in Congress",
       y = "Predicted Number of Letters",
       fill = "",
       color = "",
       shape = "") 


# Predictions for DND plot 
predicted <- predictions(m_policy_dnd,
                         newdata = values)


# DND plot
predicted %>%
  mutate(predicted = predicted*90,
         std.error = std.error*90) %>%
  ggchair() +
  labs(title = "Predicted Number of Policy Letters per Year\nDifference in Differences (Within Legislator)",
       x = "",
       y = "Predicted Number of Letters",
       fill = "",
       color = "",
       shape = "")  

# tenure
predicted <- predictions(m_policy_dnd,
                         newdata = values_tenure)

predicted %>%
    mutate(predicted = predicted*90,
         std.error = std.error*90) %>%
ggtenure() +
    geom_line(aes(x = as.numeric(year_in_congress %>% str_sub(1,1)))) + 
  labs(title = "Predicted Number of Policy Letters\nDifference in Differences (Within Legislator)",
       x = "Year in Congress",
       y = "Predicted Number of Letters",
       fill = "",
       color = "",
       shape = "") 

beta <- m_policy_dnd$coefficients %>%round(3) %>% as_tibble(rownames = "beta") %>% pivot_wider(names_from = beta)

se <- m_policy_dnd$se %>%round(3) %>% as_tibble(rownames = "se") %>% pivot_wider(names_from = se)
```

To address potential confounding in across-legislator comparisons, the estimates from Model 2 (Column 2 of Table `\ref{tab:models_policy}`) provide the estimated effects from the difference-in-differences specification in Equation `\ref{e:diff1}`. Across all measures of institutional power, we find that more power increases the level of policy work that legislators provide. Consider first the effect of being a committee chair. We estimate that becoming a committee chair causes an increase of `r beta$chair`  policy requests `\textit{per agency}` (95-percent confidence interval [`r beta$chair - se$chair*1.96`, `r beta$chair + se$chair*1.96`]). Across all 90 agencies, this represents an increase of approximately `r (beta$chair*90) %>% round(0)` additional requests per year, `r (beta$chair / mean(dcounts_tenure$perYear_policy) ) %>% round(3)*100 ``\%` of the average number of requests per year in our data. There is a smaller increase for individuals who become ranking members and those who join a Prestige Committee, though the increase is statistically significant for the prestige committee. Becoming a ranking member of a committee causes an increase of `r beta$ranking_minority` contacts per agency while joining a prestige committee causes a `r beta$chair` per agency increase in the number of contacts a member of Congress makes.

# Ratio 

- Figures: `figs/m-ratio-[1:2].png`

```{r m-ratio,  fig.show="hold", out.width="50%", fig.height=4.5, fig.cap= "Total Letters", fig.subcap= ""}
dcounts_ratio %<>% 
  mutate(Legislator = icpsr,
         Year = year) %>% 
  filter(year >2006 & year < 2019)

m_ratio_cross <- feglm(ratio ~
  chair + ranking_minority + prestige + majority +  presidents_party + 
  first + second + third + fourth + fifth + sixth,
cluster = "Legislator",
data = dcounts_ratio)

if(testing){modelsummary(m_ratio_cross, gof_omit = "R.*", coef_omit = "(Intercept)")}

coefplot(m_ratio_cross, horiz = T, drop = "(Intercept)") 



# Diff in diff
m_ratio_dnd <- feglm(ratio ~
  chair + ranking_minority + prestige + majority + presidents_party + 
  first + second + third + fourth + fifth + sixth | 
    Legislator + Year,
cluster = "Legislator",
data = dcounts_ratio)

if(testing){modelsummary(m_ratio_dnd, gof_omit = "R.*", coef_omit = "(Intercept)")}

coefplot(m_ratio_dnd, horiz = T) 
```

### Ratio Table

- Table: `tables/models_ratio.tex` (sans stars)

```{r models_ratio}
models_ratio <- list(
  "1" = m_ratio_cross,
  "2" = m_ratio_dnd
)

rows <- tibble(
  term = c("Dependent Variable", "Majoirty", "President's Party"),
  `1` = c("Count", "✓", "✓"),
  `2` =c("Count", "✓", "✓")
)

attr(rows, 'position') <- c(0, 20,21)

modelsummary(models_ratio, stars = T, 
             add_rows = rows, 
             coef_map = cm,
             gof_omit = "R.*|AIC|BIC|Log.*", 
             coef_omit = "(Intercept)|majority|presidents_party")

modelsummary(models_ratio, # stars = T, 
             add_rows = rows,               
             coef_map = cm, 
             gof_omit = "R.*|AIC|BIC|Log.*", 
             coef_omit = "(Intercept)",
             output = "latex",
             title = "The Effect of Expierence and Institutional Power on the Ratio of Constituency Service to Policy Work", 
             notes = list("Column 1 shows average differences across committee assignments and years in Congress.",
                          "Column 2 presents difference-in-differences estimates") %>% rev() ) %>% 
  format_table() %>%
   write_lines(file = here::here("tables", "models_policy.tex") )
```

### Predictions 

- Figures: `figs/m-ratio-predicted-[1:4].png`

```{r m-ratio-predicted, fig.show="hold", out.width="50%", fig.cap= "Ratio", fig.subcap= ""}
predicted <- predictions(m_ratio_cross,
                         newdata = values)



# As a plot
predicted %>%
ggchair() +
  labs(title = "Predicted Ratio of Constituent to Policy Letters\n(Cross-Sectional)",
       x = "",
       y = "Predicted Ratio of Constituent to Policy Letters",
       fill = "",
       color = "",
       shape = "")

# tenure
predicted <- predictions(m_ratio_cross,
                         newdata = values_tenure)

predicted %>%
ggtenure() +
  labs(title = "Predicted Ratio of Constituent to Policy Letters\n(Cross-Sectional)",
       x = "Year in Congress",
       y = "Predicted Ratio of Constituent to Policy Letters",
       fill = "",
       color = "",
       shape = "")


# Predictions for DND plot 
predicted <- predictions(m_ratio_dnd,
                         newdata = values)


# DND plot
predicted %>%
  ggchair() + 
  labs(title = "Predicted Ratio of Constituent to Policy Letters\nDifference in Differences (Within Legislator)",
       x = "",
       y = "Predicted Ratio of Constituent to Policy Letters",
       fill = "",
       color = "",
       shape = "")

# tenure
predicted <- predictions(m_ratio_dnd,
                         newdata = values_tenure)

predicted %>%
ggtenure() +
    geom_line(aes(x = as.numeric(year_in_congress %>% str_sub(1,1)))) + 
  labs(title = "Predicted Ratio of Constituent to Policy Letters\nDifference in Differences (Within Legislator)",
       x = "Year in Congress",
       y = "Predicted Ratio of Constituent to Policy Letters",
       fill = "",
       color = "",
       shape = "")
```

# Per District

```{r m-district,  fig.show="hold", out.width="50%"}


```
